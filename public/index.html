<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Ruslan Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body {
            background: #000;
            color: #0f0;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        #topMenu {
            padding: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
        }

        select, button {
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
        }

        #findBtn {
            background: #00ff66;
            font-weight: bold;
            width: 100%;
            margin-top: 10px;
        }

        #endBtn {
            background: #ff4444;
            color: white;
            display: none;
            font-weight: bold;
            margin-bottom: 10px;
        }

        #chat {
            display: none;
            padding: 20px;
        }

        #messages {
            background: #111;
            border-radius: 10px;
            height: 400px;
            overflow-y: auto;
            padding: 15px;
        }

        .msg {
            padding: 10px;
            margin-bottom: 10px;
            background: #222;
            color: #fff;
            border-radius: 10px;
        }

        #typing {
            color: #888;
            margin-top: 5px;
            height: 20px;
        }

        #inputBox {
            display: none;
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        #text {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: none;
            background: #333;
            color: #fff;
            font-size: 16px;
        }

        #sendBtn {
            padding: 10px 20px;
            background: #00ff66;
            font-weight: bold;
        }
    </style>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>

<body>

<div id="topMenu">
    <div>Онлайн: <span id="online">0</span></div>

    <select id="gender">
        <option>Мужчина</option>
        <option>Женщина</option>
    </select>

    <select id="searchfor">
        <option>Ищу любой</option>
        <option>Ищу мужчину</option>
        <option>Ищу женщину</option>
    </select>
</div>

<button id="findBtn">НАЙТИ СОБЕСЕДНИКА</button>
<button id="endBtn">ЗАВЕРШИТЬ ЧАТ</button>

<div id="chat">
    <div id="messages"></div>
    <div id="typing"></div>

    <div id="inputBox">
        <input id="text" type="text" placeholder="Введите сообщение...">
        <button id="sendBtn">Отправить</button>
    </div>
</div>

<script>
let socket = io();
let typingTimer;

// обновление онлайн-количества
socket.on("online_count", n => {
    document.getElementById("online").textContent = n;
});

// запуск поиска
document.getElementById("findBtn").onclick = () => {
    socket.emit("find", {
        gender: gender.value,
        searchfor: searchfor.value
    });
};

// старт чата
socket.on("chat_start", () => {
    // скрыть меню
    document.getElementById("topMenu").style.display = "none";
    document.getElementById("findBtn").style.display = "none";

    // показать интерфейс чата
    document.getElementById("chat").style.display = "block";
    document.getElementById("inputBox").style.display = "flex";
    document.getElementById("endBtn").style.display = "block";

    // очистка
    document.getElementById("messages").innerHTML = "";
    document.getElementById("typing").innerHTML = "";
});

// отправка сообщения
document.getElementById("sendBtn").onclick = sendMsg;
document.getElementById("text").onkeydown = e => {
    if (e.key === "Enter") sendMsg();
    socket.emit("typing");
};

function sendMsg() {
    let t = text.value.trim();
    if (!t) return;

    appendMsg("Вы: " + t);
    socket.emit("msg", t);
    text.value = "";
}

// вывод новых сообщений
socket.on("msg", t => {
    appendMsg("Собеседник: " + t);
});

function appendMsg(t) {
    let div = document.createElement("div");
    div.className = "msg";
    div.textContent = t;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
}

// собеседник печатает
socket.on("typing", () => {
    document.getElementById("typing").textContent = "Собеседник печатает...";
    clearTimeout(typingTimer);
    typingTimer = setTimeout(() => {
        document.getElementById("typing").textContent = "";
    }, 1500);
});

// завершение чата
document.getElementById("endBtn").onclick = () => {
    socket.emit("end");
};

socket.on("chat_end", () => {
    showMenu();
});

// при отключении собеседника
socket.on("chat_end", () => {
    showMenu();
});

// возврат в главное меню
function showMenu() {
    document.getElementById("chat").style.display = "none";
    document.getElementById("inputBox").style.display = "none";
    document.getElementById("endBtn").style.display = "none";

    document.getElementById("topMenu").style.display = "flex";
    document.getElementById("findBtn").style.display = "block";

    messages.innerHTML = "";
    typing.innerHTML = "";
}
</script>

</body>
</html>
