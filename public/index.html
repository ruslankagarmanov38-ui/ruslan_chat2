<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Ruslan Chat</title>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #000;
        color: #fff;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .top-menu {
        width: 100%;
        max-width: 700px;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chat-box {
        margin-top: 20px;
        width: 100%;
        max-width: 700px;
        height: 400px;
        overflow-y: auto;
        background: #111;
        border-radius: 10px;
        padding: 15px;
        display: none;
    }

    .msg {
        background: #222;
        padding: 10px;
        border-radius: 10px;
        margin-bottom: 10px;
    }

    #typingStatus {
        color: #0f0;
        margin-top: 5px;
        display: none;
    }

    #inputArea {
        width: 100%;
        max-width: 700px;
        margin-top: 10px;
        display: none;
        display: flex;
        gap: 10px;
    }

    input {
        flex: 1;
        padding: 12px;
        border-radius: 10px;
        border: none;
        outline: none;
    }

    .btn {
        padding: 12px 20px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        background: #00ff66;
        font-weight: bold;
    }
</style>
</head>
<body>

<div id="menu" class="top-menu">
    <div>
        Онлайн: <span id="online">0</span>
        <br>
        <select id="gender">
            <option>Мужчина</option>
            <option>Женщина</option>
        </select>
        <select id="searchFor">
            <option>Ищу любой</option>
            <option>Ищу мужчину</option>
            <option>Ищу женщину</option>
        </select>
    </div>

    <button id="findBtn" class="btn">НАЙТИ СОБЕСЕДНИКА</button>
</div>

<button id="endChatBtn" class="btn" style="display:none; margin-top:10px;">Завершить чат</button>

<div id="typingStatus">Собеседник пишет...</div>

<div id="chat" class="chat-box"></div>

<div id="inputArea">
    <input id="messageInput" placeholder="Введите сообщение..." />
    <button id="sendBtn" class="btn">Отправить</button>
</div>

<script>
const socket = io();
let partner = null;
let typingTimeout;

// вывод сообщений
function addMessage(text, self = false) {
    const chat = document.getElementById("chat");
    const div = document.createElement("div");
    div.className = "msg";
    div.style.background = self ? "#00ff66" : "#222";
    div.style.color = self ? "#000" : "#fff";
    div.textContent = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

// обновление онлайн
socket.on("online_count", n => {
    document.getElementById("online").textContent = n;
});

// кнопка поиска
document.getElementById("findBtn").onclick = () => {
    socket.emit("find", {
        gender: document.getElementById("gender").value,
        searchFor: document.getElementById("searchFor").value
    });

    document.getElementById("menu").style.display = "none";
    document.getElementById("chat").style.display = "block";
    addMessage("Поиск собеседника...");
};

// получили пару
socket.on("chat_start", () => {
    document.getElementById("chat").innerHTML = "";
    addMessage("Собеседник найден!");
    document.getElementById("inputArea").style.display = "flex";
    document.getElementById("endChatBtn").style.display = "block";
});

// получение сообщения
socket.on("msg", text => {
    addMessage(text);
});

// печатает
socket.on("typing", () => {
    const s = document.getElementById("typingStatus");
    s.style.display = "block";

    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
        s.style.display = "none";
    }, 800);
});

// конец чата
socket.on("chat_end", () => {
    addMessage("Собеседник отключился.");
    setTimeout(() => {
        location.reload();
    }, 800);
});

// отправка сообщения
document.getElementById("sendBtn").onclick = sendMessage;
document.getElementById("messageInput").onkeydown = e => {
    socket.emit("typing");
    if (e.key === "Enter") sendMessage();
};

function sendMessage() {
    const inp = document.getElementById("messageInput");
    if (!inp.value.trim()) return;

    socket.emit("msg", inp.value);
    addMessage(inp.value, true);
    inp.value = "";
}

// завершить чат
document.getElementById("endChatBtn").onclick = () => {
    socket.emit("end");
    location.reload();
};
</script>
</body>
</html>
