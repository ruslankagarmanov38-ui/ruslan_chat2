<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Ruslan Chat</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
body {
    background:#0d0d0f;
    color:white;
    font-family:Arial;
    margin:0;
    padding:0;
}

header {
    text-align:center;
    padding:20px;
    font-size:28px;
    font-weight:bold;
    color:#00ff88;
    text-shadow:0 0 10px #00ff88;
}

#menu, #chat {
    width:90%;
    max-width:500px;
    margin:30px auto;
}

button {
    width:100%;
    padding:15px;
    background:#00ff88;
    border:none;
    border-radius:10px;
    font-size:20px;
    cursor:pointer;
    transition:0.2s;
}
button:hover { background:#00cc66; }

.spinner {
    margin-top:20px;
    text-align:center;
    font-size:20px;
    color:#ccc;
    display:none;
}

.spinner::after {
    content:"";
    display:inline-block;
    width:20px;
    height:20px;
    border:4px solid #00ff88;
    border-top-color:transparent;
    border-radius:50%;
    animation:spin 0.7s linear infinite;
    margin-left:10px;
}
@keyframes spin { to { transform:rotate(360deg); } }

#cancelSearch {
    display:none;
    margin-top:15px;
    background:#ff4444;
}
#cancelSearch:hover { background:#cc0000; }

#messages {
    width:100%;
    height:350px;
    background:#1a1a1d;
    padding:10px;
    border-radius:10px;
    overflow-y:auto;
}

.msg {
    background:#2a2a2d;
    padding:10px;
    margin:8px 0;
    border-radius:10px;
}
.me { background:#004422; }
.partner { background:#222244; }

#typing {
    color:#888;
    font-size:14px;
    margin-top:5px;
    display:none;
}

#inputBox {
    display:flex;
    margin-top:15px;
}

#text {
    flex:1;
    padding:10px;
    border-radius:10px;
    border:none;
    font-size:18px;
}
</style>
</head>
<body>

<header>Ruslan Chat</header>

<div id="menu">
    <p id="online">Онлайн: 0</p>

    <select id="myGender">
        <option value="m">Мужчина</option>
        <option value="f">Женщина</option>
        <option value="a">Не важно</option>
    </select>

    <select id="seeking">
        <option value="f">Ищу женщину</option>
        <option value="m">Ищу мужчину</option>
        <option value="a">Любой</option>
    </select>

    <button id="find">Найти собеседника</button>

    <div class="spinner" id="spinner">Поиск собеседника</div>

    <button id="cancelSearch">Прекратить поиск</button>
</div>

<div id="chat" style="display:none;">
    <div id="messages"></div>
    <div id="typing">Собеседник печатает...</div>

    <div id="inputBox">
        <input type="text" id="text" placeholder="Введите сообщение...">
        <button id="send">➤</button>
    </div>

    <button id="endChat" style="margin-top:15px;background:#ff4444;">Закончить чат</button>
</div>

<script>
const socket = io();
let roomId = null;
let inSearch = false;

const online = document.getElementById("online");
const menu = document.getElementById("menu");
const chat = document.getElementById("chat");
const spinner = document.getElementById("spinner");
const cancelSearch = document.getElementById("cancelSearch");
const messages = document.getElementById("messages");
const typing = document.getElementById("typing");
const input = document.getElementById("text");

socket.on("online_count", n => {
    online.innerText = "Онлайн: " + n;
});

// ПОИСК
document.getElementById("find").onclick = () => {
    inSearch = true;
    spinner.style.display = "block";
    cancelSearch.style.display = "block";

    socket.emit("join_queue", {
        myGender: document.getElementById("myGender").value,
        seekingGender: document.getElementById("seeking").value
    });
};

cancelSearch.onclick = () => {
    inSearch = false;
    spinner.style.display = "none";
    cancelSearch.style.display = "none";

    socket.emit("leave_queue");
};

// СОВПАДЕНИЕ
socket.on("matched", data => {
    roomId = data.roomId;
    inSearch = false;

    spinner.style.display = "none";
    cancelSearch.style.display = "none";

    menu.style.display = "none";
    chat.style.display = "block";

    messages.innerHTML = "";
});

// ОТПРАВКА СООБЩЕНИЯ
document.getElementById("send").onclick = send;
input.addEventListener("keydown", e => { if (e.key === "Enter") send(); });

function send() {
    let text = input.value.trim();
    if (!text) return;

    appendMessage(text, "me");
    socket.emit("message", { roomId, text });

    input.value = "";
}

socket.on("message", data => {
    if (data.from !== socket.id) appendMessage(data.text, "partner");
});

function appendMessage(text, who) {
    let div = document.createElement("div");
    div.className = "msg " + (who === "me" ? "me" : "partner");
    div.innerText = (who === "me" ? "Вы: " : "Собеседник: ") + text;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
}

// ПЕЧАТАНИЕ
input.addEventListener("input", () => {
    socket.emit("typing", { roomId });
});

socket.on("partner_typing", () => {
    typing.style.display = "block";
    setTimeout(() => typing.style.display = "none", 600);
});

// ЗАКРЫТИЕ
document.getElementById("endChat").onclick = () => {
    socket.emit("end", { roomId });
    location.reload();
};

socket.on("ended", () => {
    alert("Собеседник вышел");
    location.reload();
});

socket.on("force_end_from_disconnect", id => {
    if (id !== socket.id) {
        alert("Собеседник закрыл вкладку");
        location.reload();
    }
});
</script>
</body>
</html>
